name: Publish Release

on:
  push:
    tags:
      - 'v*'

jobs:
  publish:
    name: Publish release ZIP
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create release ZIP
        id: create_zip
        run: |
          TAG=${{ github.ref_name }}
          ZIPNAME=season-indicator-card-${TAG}.zip
          rm -f "$ZIPNAME"
          FILES=("season-indicator-card.js" "season-indicator-card.css" "README.md" "LICENSE" "hacs.json" "screenshot.png" "manifest.json")
          for f in "${FILES[@]}"; do
            if [ -f "$f" ]; then
              echo "Adding $f"
              zip -q "$ZIPNAME" "$f"
            else
              echo "Skipping $f (not found)"
            fi
          done
          if [ ! -f "$ZIPNAME" ]; then
            echo "Error: no files were added to the ZIP. Exiting." >&2
            exit 1
          fi
          echo "zipname=$ZIPNAME" >> "$GITHUB_OUTPUT"

      - id: create_release
        name: Create GitHub Release
        uses: actions/create-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          release_name: "season-indicator-card ${{ github.ref_name }}"
          body: "Release for ${{ github.ref_name }}"
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload release asset (ZIP)
        uses: actions/upload-release-asset@v1
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ${{ steps.create_zip.outputs.zipname }}
          asset_name: season-indicator-card-${{ github.ref_name }}.zip
          asset_content_type: application/zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
